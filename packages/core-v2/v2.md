# Bloom Core V2

> Framework-agnostic authentication with Web Standard Request/Response, path-based hooks, and pluggable adapters.

**Status:** Active Development
**Date:** October 2025

---

## Completed

**Core:**
- Zod v4 schemas (User, Session, Storage)
- Crypto utilities (argon2id hashing, token generation)
- Framework-agnostic headers (8 frameworks: Next, Express, Astro, SvelteKit, Nuxt, Hono, Fastify, Elysia)

**Adapters:**
- Database: Drizzle, Kysely, Prisma, MongoDB
- Storage: Memory, Redis

**Hooks:**
- Path-based before/after hooks (e.g., `/register:before`, `/login:after`)
- Map-based storage for O(1) lookups

**Handler:**
- Router with path matching (exact, params, wildcard)
- Web Standard Request → Response
- Rate limiting (IP-based, per-path rules)

**Auth API:**
- POST `/register`, `/login`, `/logout`
- GET `/session`, `/sessions`
- DELETE `/sessions/:id`, `/sessions`
- POST `/send-verification-email`, `/verify-email`, `/request-password-reset`, `/reset-password`
- Server API: `auth.api.getSession()`

**Plugin System:**
- BloomPlugin type with routes, hooks, and API extensions
- Plugin registration in bloomAuth config
- Storage support for plugins (optional Redis/Memory caching)
- Auto-assignment of plugin API methods by ID
- Autumn plugin for Stripe billing integration:
  - Feature gating and usage tracking
  - Stripe checkout and billing portal
  - Subscription management (attach, cancel)
  - Customer data queries
  - Configurable customer ID (user-based or org-based)
  - Customer existence caching with TTL

**Tests:** 133 passing (15 files)

---

## Remaining

- Framework adapters (Next.js, Express)
- Client library (React, Vue, Svelte)

---

## Architecture Vision

### Session Caching
```typescript
const auth = bloomAuth({
  adapter: drizzleAdapter(db),
  storage: redisStorage(redis),
  session: {
    cookieCache: { maxAge: 300 }
  }
})
```

### Client Library
```typescript
import { createAuthClient } from '@bloom/react'

const client = createAuthClient()
const { data: session } = client.useSession()
```

### Plugin System ✅ (Implemented)
```typescript
import { autumn } from '@bloom/core-v2/plugins/autumn'
import { redisStorage } from '@bloom/core-v2/storage/redis'

const auth = bloomAuth({
  adapter: drizzleAdapter(db),
  storage: redisStorage(redis), // Optional: enables plugin caching
  plugins: [
    autumn({
      apiKey: 'am_sk_...',
      customerCacheTTL: 300, // Cache for 5 minutes
      // Custom customer ID for org-based tracking
      getCustomerId: async (params) => {
        const session = await auth.api.getSession(params)
        const user = await db.user.findById(session.user.id)
        return user.organizationId // Track by org instead of user
      }
    })
  ]
})

// Use plugin API methods
const { data } = await auth.api.autumn.check({
  headers: await headers(),
  body: { featureId: 'messages' }
})

// Track usage
await auth.api.autumn.track({
  headers: await headers(),
  body: { featureId: 'messages', value: 1 }
})

// Clear cache when customer deleted
await auth.api.autumn.clearCustomerCache('cust_123')

// Custom plugin example
const customPlugin: BloomPlugin = {
  id: 'custom',
  routes: [
    {
      path: '/custom-endpoint',
      method: 'POST',
      handler: async (ctx) => Response.json({ success: true })
    }
  ],
  hooks: {
    '/register': {
      after: async (ctx) => {
        await sendWelcomeEmail(ctx.user.email)
      }
    }
  },
  api: (auth, storage) => ({
    myMethod: async (params) => {
      const session = await auth.api.getSession(params)
      // Custom logic with optional storage
      if (storage) {
        await storage.set('key', 'value', 300)
      }
    }
  })
}
```